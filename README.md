
protoc-gen-yara
=================

`protoc-gen-yara` is a plugin for `protoc`, the [Google Protocol Buffers](https://developers.google.com/protocol-buffers) compiler. It takes a protocol buffer description file (.proto) and automatically generates the source code for a YARA module that accepts data encoded in the format defined by the procol buffer. The generated module allows to create YARA rules that rely on your custom-defined data structures.

For example, let's suppose that you have the following protocol buffer definition:

```protobuf
syntax = "proto3";

import "google/protobuf/descriptor.proto";

extend google.protobuf.FileOptions {
  string yara_module_name = 55000;
  string yara_module_root_message = 55001;
}

option (yara_module_name) = "pb_customer";
option (yara_module_root_message) = "Customer";

message Customer {
  string name = 1;
  int32 age = 2;
  repeated CreditCard credit_cards = 3;
}

message CreditCard {
  string number = 1;
  message Expiration {
    int32 year = 1;
    int32 month = 2;
  }
  Expiration expiration = 2;
  enum Status {
    VALID = 0;
    CANCELLED = 1;
  }
  Status status = 3;
}
```


From the above protocol buffer definition you can generate a YARA module `pb_customer` that will receive data encoded as a `Customer` message and use it for creating rules like the following ones:

```
import "pb_customer"

rule customer_under_25 {
condition:
	pb_customer.age < 25
}

```


Notice that the protobuf definition includes the following snippet:

```protobuf
import "google/protobuf/descriptor.proto";

extend google.protobuf.FileOptions {
  string yara_module_name = 55000;
  string yara_module_root_message = 55001;
}

option (yara_module_name) = "pb_customer";
option (yara_module_root_message) = "Customer";
```

This is required for `protoc-gen-yara` to be able to generate the YARA module. The `FileOptions` message defined in `google/protobuf/descriptor.proto` contains the options accepted by the `option` statement. `FileOptions` is extended with two custom options `yara_module_name` and `yara_module_root_message` whose values are assigned in the last two lines.

 The `yara_module_name` option defines the module's name (the one that you will later use in `import` statements in your YARA rules), while `yara_module_root_message` is the name of a message defining the top-level structure for the module. You can have multiple message definitions in your proto file, but only one can be the root message.

In the example above, because the root message is `Customer` and the module's name is `pb_customer` you will access fields `name` and `age` as `pb_customer.name` and `pb_customer.age` respectively.



#### Installing protoc-gen-yara

```shell
git clone https://github.com/VirusTotal/protoc-gen-yara
cd protoc-gen-yara/
go install .
```



#### Generating a YARA module

In order to generate the YARA module for your protocol buffer you must have `protoc` installed. You can download a [precompiled binary](https://github.com/protocolbuffers/protobuf/releases) from its GitHub page or use a package for your platform. Ubuntu has the `protobuf-compiler` package and in Mac OS X you can use a [brew formula](https://formulae.brew.sh/formula/protobuf). You will also need [protobuf-c](https://github.com/protobuf-c/protobuf-c), a pure C protocol buffer runtime and code generator, which also has its own package and [brew formula](https://formulae.brew.sh/formula/protobuf-c).

###### Ubuntu

```bash
apt install protobuf-compiler protobuf-c-compiler libprotobuf-c-dev
```

###### Mac OS X

```bash
brew install protobuf protobuf-c
```

After installing `protoc-gen-yara` and its pre-requisites you should have `protoc`, `protoc-gen-c` and `proto-c-yara` in your path.

Now, from the `protocol-gen-yara` directory use the following command for generating a YARA module based in `example.proto`:

```bash
protoc --c_out=. --yara_out=. example/example.proto
```

This command will generate the following files:

- example.c. (the YARA module's source code, generated by `protoc-gen-yara` )
- example.pb-c.h (header file for example.pb-c.c, generated by `protoc-gen-c`)
- example.pb-c.c (pure C encoder/decoder for protobufs defined in example.proto, generated by `protoc-gen-c`)
